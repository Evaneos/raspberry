{"version":3,"sources":["../src/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import { createServer, connect } from 'net';\nconst argv = require('minimist')(process.argv.slice(2));\n\nconst serverClients = new Map();\nlet client;\n\nconst server = createServer(socket => {\n    console.log('client connected');\n    let mac;\n\n    socket.on('end', function() {\n        console.log('client disconnected');\n        if (mac && serverClients.get(mac).socket === socket) {\n            serverClients.delete(mac);\n        }\n\n        if (mac && client) {\n            client.write('disconnected: ' + mac + ';');\n        }\n    });\n\n    socket.on('data', function(data) {\n        const string = data.toString();\n\n        if (string === 'ping') {\n            socket.write('pong');\n            return;\n        }\n\n        console.log('data', string);\n\n        string.split(';').forEach((string) => {\n            if (string === '') {\n                return;\n            }\n\n            const splittedString = string.split(': ');\n\n            if (splittedString.length !== 2) {\n                console.log('unexpected format, length = ' + splittedString.length);\n                return socket.end();\n            }\n\n            const [instruction, value] = splittedString;\n\n            switch (instruction) {\n                case 'ping':\n                    socket.write('pong');\n                    break;\n\n                case 'hello':\n                    const [macAddress, ip] = value.split(',');\n                    mac = macAddress;\n                    serverClients.set(mac, { socket, ip });\n\n                    if (client) {\n                        client.write(`connected: ${mac},${ip};`);\n                    }\n\n                    break;\n\n                case 'mac':\n                    mac = value;\n                    serverClients.set(mac, { socket });\n\n                    if (client) {\n                        client.write(`connected: ${mac};`);\n                    }\n\n                    break;\n\n                default:\n                    console.log('unsupported instruction by client ' + mac);\n                    return socket.end();\n            }\n        });\n    });\n});\n\nserver.listen(argv.port || 3007);\n\n(function openSocket() {\n    client = connect(argv.socketWebserver || __dirname + '/../../socket-webserver', () => {\n        console.log('connected to web server');\n        const keys = [];\n        for (let key of serverClients.keys()) {\n            keys.push(key);\n        }\n\n        client.write('connected-clients: ' + keys.map(key => `${key}|${serverClients.get(key).ip}`).join(',') + ';');\n    });\n\n    client.setKeepAlive(true);\n    client.on('error', (err) => {\n        client = null;\n        console.log(err.message);\n\n        setTimeout(() => openSocket(), 1000);\n    });\n\n    client.on('data', function(data) {\n        const string = data.toString();\n        console.log('data', string);\n\n        const [instruction, value] = string.split(': ');\n\n        switch (instruction) {\n            case 'pong':\n                break;\n\n            case 'url':\n            case 'change-url':\n            case 'refresh':\n                const [mac, url] = value.split(',', 2);\n                const socket = serverClients.get(mac).socket;\n                if (socket) {\n                    socket.write(instruction + ': ' + url);\n                }\n\n                break;\n\n            default:\n                console.log('unsupported instruction: ' + instruction);\n                break;\n        }\n    });\n})();\n"]}